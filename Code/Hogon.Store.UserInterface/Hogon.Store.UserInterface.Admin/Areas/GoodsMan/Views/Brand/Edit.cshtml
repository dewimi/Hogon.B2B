@{
    ViewBag.Title = "品牌管理";
    Layout = "~/Views/Shared/_MenuLayout.cshtml";
<link href="~/Content/css/style.css" rel="stylesheet" />
<link href="~/Content/css/chosen.css" rel="stylesheet" />
<script src="~/Scripts/plugins/chosen.jquery.js"></script>
<script src="~/Scripts/plugins/content.js"></script>
<script src="~/Scripts/plugins/china_area.js" type="text/javascript"></script>
}
@section formHeader{

<div class="header">
    <h2 class="headerline">品牌管理</h2>
</div>
}
<form name="myForm" novalidate>
    <div class="form-group">
        <div class="basic">
            <input type="hidden" name="id" ng-model="Guid" />
            <table>
                <tr>
                    <td><span>品牌名称:</span></td>
                    <td>
                        <input type="text" id="BrandName" name="BrandName " class="form-control" ng-model="BrandName " required>
                    </td>
                    <td>
                        <p>
                            <span style="color:red" ng-show="myForm.BrandName .$dirty && myForm.BrandName .$invalid">
                                <span ng-show="myForm.BrandName .$error.required">品牌名称不能重复或为空</span>
                            </span>
                        </p>
                    </td>
                </tr>
                <tr>
                    <td><span>商品分类:</span></td>
                    <td>
                        <select data-placeholder="请选择商品分类" class="chosen-select" multiple style="width:350px;" tabindex="4" id="goodsType"></select>
                    </td>
                </tr>
                <tr>
                    <td><span>品牌Logo:</span></td>
                    <td>
                        @*图片*@
                        @*<input type="text" name="BrandLogo" id="BrandLogo" class="form-control" ng-model="BrandLogo " required>*@
                    </td>
                </tr>
                <tr>
                    <td><span>品牌别名:</span></td>
                    <td>
                        <input type="text" id="BrandAlias" name="BrandAlias " class="form-control" ng-model="BrandAlias " required>
                    </td>
                </tr>
                <tr>
                    <td>品牌所在地:</td>
                    <td>
                        <div class="col-sm-5 ibox">
                            <div class="col-sm-4">
                                <select id="nation" style="width:75px;margin-left:-15px" class="form-control" onchange="ChangeNation()">
                                    <option value="国内">国内</option>
                                    <option value="国外">国外</option>
                                </select>
                            </div>
                            <div class="col-sm-4" style="margin-left:20px;" id="China">
                                <select id="s_province" name="s_province" class="form-control " style="width:100px;">
                                    <option value="省份">省份</option>
                                    <option value="北京市">北京市</option>
                                    <option value="天津市">天津市</option>
                                    <option value="上海市">上海市</option>
                                    <option value="重庆市">重庆市</option>
                                    <option value="河北省">河北省</option>
                                    <option value="山西省">山西省</option>
                                    <option value="内蒙古">内蒙古</option>
                                    <option value="辽宁省">辽宁省</option>
                                    <option value="吉林省">吉林省</option>
                                    <option value="黑龙江省">黑龙江省</option>
                                    <option value="江苏省">江苏省</option>
                                    <option value="浙江省">浙江省</option>
                                    <option value="安徽省">安徽省</option>
                                    <option value="福建省">福建省</option>
                                    <option value="江西省">江西省</option>
                                    <option value="山东省">山东省</option>
                                    <option value="河南省">河南省</option>
                                    <option value="湖北省">湖北省</option>
                                    <option value="湖南省">湖南省</option>
                                    <option value="广东省">广东省</option>
                                    <option value="广西">广西</option>
                                    <option value="海南省">海南省</option>
                                    <option value="四川省">四川省</option>
                                    <option value="贵州省">贵州省</option>
                                    <option value="云南省">云南省</option>
                                    <option value="西藏">西藏</option>
                                    <option value="陕西省">陕西省</option>
                                    <option value="甘肃省">甘肃省</option>
                                    <option value="青海省">青海省</option>
                                    <option value="宁夏">宁夏</option>
                                    <option value="新疆">新疆</option>
                                    <option value="香港">香港</option>
                                    <option value="澳门">澳门</option>
                                    <option value="台湾省">台湾省</option>
                                </select>
                                <select id="s_city" name="s_city" class="form-control" style="width:100px;">
                                    <option value="地级市">地级市</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-4" style="margin-left:10px;" id="Foreign">
                            <select id="foreignCountry" name="s_province" style="width:80px;" tabindex="4" class="form-control col-sm-4">
                                <option value="美国">美国</option>
                                <option value="德国">德国</option>
                                <option value="法国">法国</option>
                                <option value="日本">日本</option>
                            </select>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</form>


<script type="text/javascript">
    var app = angular.module('myApp', []);
    app.controller('validateCtrl', function ($scope, $http) {

        //商品分类下拉框绑值
        $http({
            method: 'POST',
            url: '@Url.Action("FindGoodsTypeForDrop")'
        }).then(function successCallback(response) {
            // 请求成功执行代码
            $.each(response.data, function (index, v) {
                $("#goodsType").append("<option hassubinfo='true' value='" + v.Id + "'>" + v.Name + "</option>");
            })
            //多选下拉渲染
            $("#goodsType").chosen();
        }, function errorCallback(response) {
            // 请求失败执行代码
        });

        var id = window.location.search;//获取Id
        id = id.substring(id.indexOf('=') + 1);
        if (id != "") {
            //编辑
            $http({
                method: 'POST',
                url: '@Url.Action("FindBrandById")',
                data: { Id: id }
            }).then(function successCallback(response) {
                console.info(response);
                // 请求成功执行代码
                $scope.Guid = response.data.Id;
                $scope.BrandName = response.data.BrandName;
                $scope.BrandAlias = response.data.BrandAlias;
                //$scope.BrandLogo = response.data.BrandLogo;
                $.each(response.data.GoodsTypeIds, function (index, v) {
                    $("#goodsType option[value='" + v + "']").attr("selected", "true");
                });
                $.each(response.data.ProductIds, function (index, v) {
                    $("#product option[value='" + v + "']").attr("selected", "true");
                });
                $(".chosen-select").trigger("chosen:updated");
                $("#nation").val(response.data.Nation);
                ChangeNation();
                if (response.data.Nation == "国内") {
                    if (response.data.Country != "") {
                        _init_area();
                        $("select option[value='" + response.data.Country + "']").attr("selected", "selected");
                       change(1);
                        if (response.data.City != "") {
                            $("select option[value='" + response.data.City + "']").attr("selected", "selected");                            
                        }
                    }
                } else {
                    $("#foreignCountry").val(response.data.Country);
                }
            }, function errorCallback(response) {
                // 请求失败执行代码
            });
        }
        ChangeNation();
        //判断品牌名是否重复
        $("#BrandName").blur(function () {
            Repetition();
        })

        //保存
        $scope.saveChange = function () {
            Repetition();
            //判断商品分类是否为空
            var goodsType = $("#goodsType").val();
            if (goodsType == "") {
                goodsType = "";
            };
            //判断产品是否为空
            var prodcut = $("#product").val();
            if (prodcut == "") {
                prodcut = "";
            };
            var nation = $("#nation").val();
            var country = "";
            if (nation == "国内") {
                if ($("#s_province").val() != "省份") {
                    country = $("#s_province").val();
                }
            } else {
                country = $("#foreignCountry").val();
            }

            var city = $("#s_city").val();
            if (city == "地级市") {
                city = "";
            }

            $scope.Brand = {
                "Id": $scope.Guid,
                "BrandName": $scope.BrandName,
                "BrandAlias": $scope.BrandAlias,
                //"BrandLogo": $scope.BrandLogo,
                "SalePrice": $scope.SalePrice,
                "GoodsTypeIds": goodsType,
                "ProdcutIds": prodcut,
                "Nation": nation,
                "Country": country,
                "City": city
            };
            $http({
                method: 'POST',
                url: '@Url.Action("Save")',
                data: $scope.Brand
            }).then(function successCallback(response) {
                // 请求成功执行代码
                location.href = "/GoodsMan/Brand/Index";
            }, function errorCallback(response) {
                // 请求失败执行代码
                swal(response.data, "", "warning");
            });
        }

        //判断重复
        function Repetition() {

            $scope.Brand = {
                "Id": $scope.Guid,
                "BrandName": $scope.BrandName,
            };
            $http({
                method: 'POST',
                url: '@Url.Action("FindBrandByBrandName")',
                data: $scope.Brand
            }).then(function successCallback(response) {
                // 请求成功执行代码
                if (response.data == 1) {
                    $scope.BrandName = "";

                }
            }, function errorCallback(response) {
                // 请求失败执行代码
            });
        }

        //初始化地区联动
        _init_area();
    });
    //改变国内国外下拉显示
    function ChangeNation() {
        var nation = $("#nation").val();
        if (nation == "国外") {
            $("#China").hide();
            $("#Foreign").show();
        } else {
            $("#China").show();
            $("#Foreign").hide();
        }
    }
</script>
