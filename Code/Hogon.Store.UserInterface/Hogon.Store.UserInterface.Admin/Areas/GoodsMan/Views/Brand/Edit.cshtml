@{
    ViewBag.Title = "品牌管理";
    Layout = "~/Views/Shared/_MenuLayout.cshtml";
}
<link href="~/Content/css/style.css" rel="stylesheet" />
<link href="~/Content/css/chosen.css" rel="stylesheet" />
<script src="~/Scripts/plugins/chosen.jquery.js"></script>
<script src="~/Scripts/plugins/content.js"></script>
<script src="~/Scripts/plugins/china_area.js" type="text/javascript"></script>
<!-- iCheck-->
<script src="~/Scripts/hogon/js/plugins/iCheck/icheck.min.js"></script>
<script src="~/Scripts/hogon/js/plugins/fileinput/fileinput.min.js"></script>
<script src="~/Scripts/hogon/js/plugins/fileinput/fileinput-zh.js"></script>

<div class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>品牌管理<input type="hidden" name="id" ng-model="Guid" /></h5>
                    </div>
                    <div class="ibox-content">
                        <form method="get"  name="myForm" novalidate class="form-horizontal" id="commentForm">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">品牌名称<i class="fa fa-asterisk fa-red"></i></label>
                                <div class="col-sm-7">
                                    <input type="text" id="BrandName" name="BrandName" ng-model="BrandName" class="form-control" required="" aria-required="true">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">商品分类</label>
                                <div class="col-sm-7">
                                    <select data-placeholder="请选择商品分类" class="chosen-select m-b" multiple style="width:100%;height:34px;" name="ParentId" id="goodsType"></select>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">品牌别名<i class="fa fa-asterisk fa-red"></i></label>
                                <div class="col-sm-7">
                                    <input type="text" id="BrandAlias" name="BrandAlias" ng-model="BrandAlias" class="form-control" required="" aria-required="true">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">网址<i class="fa fa-asterisk fa-red"></i></label>
                                <div class="col-sm-7">
                                    <input type="text" id="Url" name="Url" ng-model="Url" class="form-control" required="" aria-required="true">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">品牌所在地</label>
                                <div class="col-sm-7">
                                    <div class="row">
                                        <div class="col-sm-4">
                                            <select id="nation" class="form-control m-b" onchange="ChangeNation()">
                                                <option value="国内">国内</option>
                                                <option value="国外">国外</option>
                                            </select>
                                        </div>
                                        <div class="col-sm-4" id="China-1">
                                            <select id="s_province" name="s_province" class="form-control m-b">
                                                <option value="省份">省份</option>
                                                <option value="北京市">北京市</option>
                                                <option value="天津市">天津市</option>
                                                <option value="上海市">上海市</option>
                                                <option value="重庆市">重庆市</option>
                                                <option value="河北省">河北省</option>
                                                <option value="山西省">山西省</option>
                                                <option value="内蒙古">内蒙古</option>
                                                <option value="辽宁省">辽宁省</option>
                                                <option value="吉林省">吉林省</option>
                                                <option value="黑龙江省">黑龙江省</option>
                                                <option value="江苏省">江苏省</option>
                                                <option value="浙江省">浙江省</option>
                                                <option value="安徽省">安徽省</option>
                                                <option value="福建省">福建省</option>
                                                <option value="江西省">江西省</option>
                                                <option value="山东省">山东省</option>
                                                <option value="河南省">河南省</option>
                                                <option value="湖北省">湖北省</option>
                                                <option value="湖南省">湖南省</option>
                                                <option value="广东省">广东省</option>
                                                <option value="广西">广西</option>
                                                <option value="海南省">海南省</option>
                                                <option value="四川省">四川省</option>
                                                <option value="贵州省">贵州省</option>
                                                <option value="云南省">云南省</option>
                                                <option value="西藏">西藏</option>
                                                <option value="陕西省">陕西省</option>
                                                <option value="甘肃省">甘肃省</option>
                                                <option value="青海省">青海省</option>
                                                <option value="宁夏">宁夏</option>
                                                <option value="新疆">新疆</option>
                                                <option value="香港">香港</option>
                                                <option value="澳门">澳门</option>
                                                <option value="台湾省">台湾省</option>
                                            </select>
                                        </div>
                                        <div class="col-sm-4"  id="China-2">
                                            <select id="s_city" name="s_city" class="form-control">
                                                <option value="地级市">地级市</option>
                                            </select>
                                        </div>
                                        <div class="col-sm-4" id="Foreign">
                                            <select id="foreignCountry" name="s_province" class="form-control col-sm-4 m-b">
                                                <option value="美国">美国</option>
                                                <option value="德国">德国</option>
                                                <option value="法国">法国</option>
                                                <option value="日本">日本</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group" id="fileupload">
                                <label class="col-sm-3 control-label">品牌Logo</label>
                                <div class="col-sm-7">
                                    <input type="file" id="file-Portrait1" class="file-loading">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3"></label>
                                <div class="col-sm-8">
                                    <button type="button" class="btn btn-primary" ng-click="SaveBrand()" ng-disabled="myForm.$invalid">保存</button>
                                    <button type="button" class="btn btn-white" ng-click="BackBrand()" ng-disabled="myForm.$invalid">返回</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- 全局js -->
    <script src="js/jquery-2.1.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <!-- jQuery 表单验证-->
    <script src="js/plugins/validate/jquery.validate.min.js"></script>
    <script src="js/plugins/validate/messages_zh.min.js"></script>

    <!-- 自定义js -->
    <script src="js/content.js?v=1.0.0"></script>

    <!-- iCheck-->
    <script src="js/plugins/iCheck/icheck.min.js"></script>
    <script src="js/plugins/fileinput/fileinput.min.js"></script>
    <script src="js/plugins/fileinput/fileinput-zh.js"></script>
    <script type="text/javascript">
        $(function () {
            $('#file-Portrait1').fileinput({
                language:'zh',
                showUpload: false,
                mainClass: "input-group-lg",
                allowedFileExtensions: ["jpg", "png", "gif","pdf"]
            });
        });
    </script>
</div>

<script type="text/javascript">
    var fileUrl, fileName, fileSize, fileType;

    var app = angular.module('myApp', []);
    app.controller('validateCtrl', function ($scope, $http) {

        var id = window.location.search;//获取Id
        id = id.substring(id.indexOf('=') + 1);

        //商品分类下拉框绑值->编辑绑值
        $http({
            method: 'POST',
            url: '@Url.Action("FindGoodsTypeForDrop")'
        }).then(function successCallback(response) {
            // 请求成功执行代码
            $.each(response.data, function (index, v) {
                $("#goodsType").append("<option hassubinfo='true' value='" + v.Id + "'>" + v.Name + "</option>");
            })
            //多选下拉渲染
            $("#goodsType").chosen();
            if (id != "") {
                //编辑
                $http({
                    method: 'POST',
                    url: '@Url.Action("FindBrandById")',
                    data: { Id: id }
                }).then(function successCallback(response) {
                    console.info(response);
                    // 请求成功执行代码
                    $scope.Guid = response.data.Id;
                    $scope.BrandName = response.data.BrandName;
                    $scope.BrandAlias = response.data.BrandAlias;
                    //$scope.BrandLogo = response.data.BrandLogo;
                    $scope.Url = response.data.Url;
                    $.each(response.data.GoodsTypeIds, function (index, v) {
                        $("#goodsType option[value='" + v + "']").attr("selected", "true");
                    });
                    $(".chosen-select").trigger("chosen:updated");
                    $("#nation").val(response.data.Nation);
                    ChangeNation();
                    if (response.data.Nation == "国内") {
                        if (response.data.Country != "") {
                            _init_area();
                            $("select option[value='" + response.data.Country + "']").attr("selected", "selected");
                            change(1);
                            if (response.data.City != "") {
                                $("select option[value='" + response.data.City + "']").attr("selected", "selected");
                            }
                        }
                    } else {
                        $("#foreignCountry").val(response.data.Country);
                    }
                }, function errorCallback(response) {
                    // 请求失败执行代码
                });
            }
        }, function errorCallback(response) {
            // 请求失败执行代码
        });


        ChangeNation();
        //判断品牌名是否重复
        $("#BrandName").blur(function () {
            Repetition();
        })

        //保存
        $scope.SaveBrand = function () {
            //上传图片后保存使用说明
            if (fileName == null && fileSize == null && fileType == null && fileUrl == null) {
                swal("请上传图片");
            } else {
                $http({
                    method: 'POST',
                    url: '/FileUpload/SeveFile',
                    data: JSON.stringify({ FileName: fileName, FileType: fileType, FileSize: fileSize, Url: fileUrl })
                }).then(function successCallback(response) {
                    Repetition();
                    //判断商品分类是否为空
                    var goodsType = $("#goodsType").val();
                    if (goodsType == "") {
                        goodsType = "";
                    };
                    //判断产品是否为空
                    var prodcut = $("#product").val();
                    if (prodcut == "") {
                        prodcut = "";
                    };
                    var nation = $("#nation").val();
                    var country = "";
                    if (nation == "国内") {
                        if ($("#s_province").val() != "省份") {
                            country = $("#s_province").val();
                        }
                    } else {
                        country = $("#foreignCountry").val();
                    }
                    var city = $("#s_city").val();
                    if (city == "地级市") {
                        city = "";
                    }
                    $scope.Brand = {
                        "Id": $scope.Guid,
                        "BrandName": $scope.BrandName,
                        "BrandAlias": $scope.BrandAlias,
                        "BrandLogo": fileName,
                        "SalePrice": $scope.SalePrice,
                        "GoodsTypeIds": goodsType,
                        "ProdcutIds": prodcut,
                        "Nation": nation,
                        "Country": country,
                        "City": city,
                        "Url": $scope.Url,
                        "FIleUploadId": response.data,
                    };
                    $http({
                        method: 'POST',
                        url: '@Url.Action("Save")',
                        data: $scope.Brand
                    }).then(function successCallback(response) {
                        // 请求成功执行代码
                        location.href = "/GoodsMan/Brand/Index";
                    }, function errorCallback(response) {
                        // 请求失败执行代码
                        swal(response.data, "", "warning");
                    });
                });
            }
        }

        //返回
        $scope.BackBrand = function () {
            window.location.href = "/GoodsMan/Brand/Index";
        }

        //判断重复
        function Repetition() {
            $scope.Brand = {
                "Id": $scope.Guid,
                "BrandName": $scope.BrandName,
            };
            $http({
                method: 'POST',
                url: '@Url.Action("FindBrandByBrandName")',
                data: $scope.Brand
            }).then(function successCallback(response) {
                // 请求成功执行代码
                if (response.data == 1) {
                    $scope.BrandName = "";

                }
            }, function errorCallback(response) {
                // 请求失败执行代码
            });
        }
        //初始化地区联动
        _init_area();
    });
    //改变国内国外下拉显示
    function ChangeNation() {
        var nation = $("#nation").val();
        if (nation == "国外") {
            $("#China-1").hide();
            $("#China-2").hide();
            $("#Foreign").show();
        } else {
            $("#China-1").show();
            $("#China-2").show();
            $("#Foreign").hide();
        }
    }
    //图片上传
    $(document).ready(function () {
        ////图片上传成功回调函数
        $(".file-loading").on("fileuploaded", function (event, data, previewId, index) {
            fileUrl = data.response.fileUrl;
            fileName = data.response.fileName;
            fileSize = data.response.fileSize;
            fileType = data.response.fileType;
        });

        //创建图片上传控件
        $(".file-loading").fileinput({
            uploadUrl: '/FileUpload/FileUpload',
            allowedFileExtensions: ["jpg", "png", "gif", "pdf"],
            maxImageWidth: 50,
            maxImageHeight: 50,
            uploadLabel: "",
            uploadTitle: "上传文件",
            removeLabel: "",
            removeTitle: "删除文件",
            browseLabel: "",
            maxFileCount: 1,
            previewFileType: "image",
            browseLabel: "",
            browseIcon: "<i class=\"glyphicon glyphicon-picture\"></i> ",
        });

    });
</script>
