
@{
    ViewBag.Title = "禾工大型B2B行业平台";
    Layout = "~/Views/Shared/_MenuLayout.cshtml";
}

    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>菜单设置</h5>
                    </div>
                    <div class="ibox-content">
                        <form method="get" class="form-horizontal" id="commentForm">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">上级菜单</label>
                                <div class="col-sm-6">
                                    <select class="form-control" ng-model="previousMenu" name="PreviousMenu" id="parent">
                                        <option ng-model="previousMenu" class="typename"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">菜单编码</label>
                                <div class="col-sm-6">
                                    <input type="text" name="code" class="form-control" ng-model="code" required>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">菜单名称</label>
                                <div class="col-sm-6">
                                    <input type="text" name="parentname" class="form-control" ng-model="parentname" required>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">URL</label>
                                <div class="col-sm-6">
                                    <input type="text" name="parentUrl" class="form-control" ng-model="parentUrl" required>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">小图标</label>
                                <div class="col-sm-6">
                                    <input type="text" name="icon" class="form-control" ng-model="icon" >
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">排序</label>
                                <div class="col-sm-6">
                                    <input type="text" name="icon" class="form-control" ng-model="sort">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">是否启用</label>
                                <div class="col-sm-6">
                                    <div class="checkbox i-checks">
                                        <label>
                                            <input type="checkbox" value="" id="enabled"> <i></i> 是否启用
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">通用权限</label>
                                <div class="col-sm-6">
                                    <div class="checkbox i-checks general">

                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">创建时间</label>
                                <div class="col-sm-6">
                                    <div class="checkbox i-checks">
                                        <label id="createdTime">@ViewBag.CreatedTime</label>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">修改时间</label>
                                <div class="col-sm-6">
                                    <div class="checkbox i-checks">
                                        <label id="updatedTime">@ViewBag.UpdatedTime</label>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div style="display:none;" id="purviewMenus" class="form-group">
                                <label class="col-sm-3 control-label">菜单权限</label>
                                <div class="col-sm-6">
                                    <div class="checkbox i-checks">
                                        <table>
                                            <tr>
                                                <td><span>菜单功能:&nbsp;&nbsp;</span></td>
                                                <td class="menufun">
                                                    <table class="table table-striped">
                                                        <thead>
                                                            <tr class="listheader">
                                                                <th>功能名称</th>
                                                                <th>功能编号</th>
                                                                <th>是否可用</th>
                                                                <th>操作</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="functionlist"></tbody>
                                                    </table>
                                                    <a title="添加菜单">添加菜单权限</a>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>

                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-3"></label>
                                <div class="col-sm-8">
                                    <button class="btn btn-primary" type="submit" ng-click="saveChange()">保存内容</button>
                                    <button class="btn btn-white" onclick="history.back()">返 回</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- jQuery 表单验证-->
    <script src="~/Scripts/hogon/js/plugins/validate/jquery.validate.min.js"></script>
    <script src="~/Scripts/hogon/js/plugins/validate/messages_zh.min.js"></script>
    <!-- 自定义js -->
    <script src="~/Scripts/hogon/js/content.js"></script>
    <!-- iCheck-->
    <script src="~/Scripts/hogon/js/plugins/iCheck/icheck.min.js"></script>
    <script src="~/Scripts/hogon/js/plugins/fileinput/fileinput.min.js"></script>
    <script src="~/Scripts/hogon/js/plugins/fileinput/fileinput-zh.js"></script>

    <script type="text/javascript">
        $.validator.setDefaults({
            highlight: function (element) {
                $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
            },
            success: function (element) {
                element.closest('.form-group').removeClass('has-error').addClass('');
            },
            errorElement: "span",
            errorPlacement: function (error, element) {
                if (element.is(":radio") || element.is(":checkbox")) {
                    error.appendTo(element.parent().parent().parent());
                } else {
                    error.appendTo(element.parent());
                }
            },
            errorClass: "help-block m-b-none",
            validClass: "help-block m-b-none"
        });

        var menuId = 0;
        var app = angular.module('myApp', []);
        app.controller('validateCtrl', function ($scope, $http) {
          
            var id = window.location.search; //获取ID
            id = id.substring(id.indexOf('=') + 1);
            $scope.menuid = id;
            //创建通用权限
            $scope.createdFunction = function () {
                $http({
                    method: 'POST',
                    url: '/Dictionary/FindFunctionTypes',
                    data: null
                }).then(function successCallback(response) {
                    // 请求成功执行代码
                    $.each(response.data, function (index, v) {
                        $(".general").append("<label><input type='checkbox' class = 'generalFunction"
                            + index + "' value = '" + v.Value + "' action = '" + v.Key + "'><i></i>" + v.Value + "</label>");
                        $("[value = '" + v.Value + "']").attr('checked', true);
                    });
                    iCheck();
                }, function errorCallback(response) {
                    // 请求失败执行代码
                });
            }


            //绑定父菜单
            $scope.bindParentMenu = function () {
                $http({
                    method: 'POST',
                    url: '@Url.Action("GetPreviousMenu")',
                    data: null
                }).then(function successCallback(response) {
                    // 请求成功执行代码
                    $("#parent").append("<option value='meren' selected='selected'>"
                        + "－－请选择上级分类－－</option>");

                    $("#parent").click(function () {
                        $("#parent option[value='meren']").remove()
                    })

                    $.each(response.data, function (index, v) {

                        if (v.ParentId == null) {
                            var option = $("<option value = '" + v.Id + "'></option>").text(v.Name);
                            $("#parent").append(option);
                        }
                    })

                    $scope.createdFunction();
                }, function errorCallback(response) {
                    // 请求失败执行代码
                });
            }
           
            if (id != "") {
                $http({
                    method: 'POST',
                    url: '@Url.Action("GetPreviousMenu")',
                    data: null
                }).then(function successCallback(response) {
                    // 请求成功执行代码
                    $.each(response.data, function (index, v) {

                        if (v.ParentId == null) {
                            var option = $("<option value = '" + v.Id + "'></option>").text(v.Name);
                            $("#parent").append(option);
                        }
                    })

                    $scope.createdFunction();
                }, function errorCallback(response) {
                    // 请求失败执行代码
                });
                $http({
                    method: 'POST',
                    url: '/Security/Menu/GetMenuById',
                    data: JSON.stringify({ Id: id, menuId: $scope.menuid })
                }).then(function successCallback(response) {
                    // 请求成功执行代码
                    menuId = response.data.Id;
                    $("#parent option[value='meren']").remove();
                    $(".typename").text(response.data.ParentName);
                    $scope.code = response.data.Code;
                    $scope.parentname = response.data.Name;
                    $scope.parentUrl = response.data.URL;
                    $scope.icon = response.data.Icon;
                    $scope.sort = response.data.Sort;
                    if (response.data.DisplayIsEnable == "可用")
                        $scope.enabled = true;
                    else
                        $scope.enabled = false;
                    $("#createdTime").text(response.data.DisplayCreatedTime);
                    $(".purviewMenus").show();
                    $scope.bindMenuFunction();
                }, function errorCallback(response) {
                    // 请求失败执行代码

                });
            } else {
                $scope.bindParentMenu();
            }

            ///小图标上传
            //$("#input-1a").fileinput({
            //    'theme': 'explorer',
            //    'uploadUrl': '/FileUpload/FileUpload',
            //    overwriteInitial: false,
            //    initialPreviewAsData: true,
            //    uploadLabel: "",
            //    uploadTitle: "上传文件",
            //    removeLabel: "",
            //    removeTitle: "删除文件",
            //    browseLabel: "",
            //    maxFileCount: 1,
            //    previewFileType: "image",
            //    browseLabel: "",
            //    browseIcon: "<i class=\"glyphicon glyphicon-picture\"></i> ",
            //    //maxFileSize: 0,//单位为kb，如果为0表示不限制文件大小
            //    // maxFileCount:5 //最大文件上传数
            //});

            //保存基本信息
            $scope.saveChange = function () {
                if ($scope.code != null && $scope.parentname != null && $scope.parentUrl != null) {
                    var arr = Array();
                    //获取通用功能
                    $("[type='checkbox']").each(function (index) {
                        if ($(".generalFunction" + index + "").attr('checked')) {
                            arr[index] = {
                                Name: $(".generalFunction" + index + "").attr('value'),
                                Code: $(".generalFunction" + index + "").attr('action'),
                                IsEnable: true
                            }
                        }
                    });
                    var previousMenu = $("#parent").val();
                    var enabled = $("#enabled").parent().attr('class');
                    if (enabled == "icheckbox_square-green checked") {
                        enabled = true;
                    } else if (enabled == "icheckbox_square-green") {
                        enabled = false;
                    }
                    var jsondata = {
                        "Id": $scope.menuid, "ParentId": previousMenu, "Code": $scope.code, "Name": $scope.parentname, "Url": $scope.parentUrl, "Icon": $scope.icon, "IsEnable": enabled,
                        "Sort": $scope.sort, generalFunction: arr
                    }
                    $http({
                        method: 'POST',
                        url: '/Security/Menu/Save',
                        data: JSON.stringify(jsondata)
                    }).then(function successCallback(response) {
                        // 请求成功执行代码
                        $scope.menuid = response.data;
                        swal("保存成功！")
                        $("#purviewMenus").show();

                    }, function errorCallback(response) {
                        // 请求失败执行代码

                    });
                }
            }

            //保存菜单功能
            $scope.saveMenuFunction = function () {

                if ($('#isEnabled').attr('checked')) {
                    enabled = 'true';
                } else {
                    enabled = 'false';
                }
                var createdTime = $("#createdtime").text();
                var updatedTime = $("#updatedtime").text();
                $scope.master = { Id: $scope.menuFcunId, Code: $scope.functionCode, Name: $scope.functionName, IsEnable: enabled, CreatedTime: createdTime, UpdatedTime: updatedTime, CreatorId: 1, UpdaterId: 1, menuId: menuId };
                $http({
                    method: 'POST',
                    url: '/Security/Menu/SaveMenuFunction',
                    data: JSON.stringify($scope.master)
                }).then(function successCallback(response) {
                    //绑定菜单功能列表
                    $scope.bindMenuFunction();

                }, function errorCallback(response) {
                    // 请求失败执行代码

                });
            }

            //绑定菜单功能列表
            $scope.bindMenuFunction = function () {
                $http({
                    method: 'POST',
                    url: '@Url.Action("GetMenuFunctions")',
                    data: JSON.stringify({ menuId: menuId })
                }).then(function successCallback(response) {
                    //创建表
                    CreateTable(response.data);
                    $scope.operate();

                }, function errorCallback(response) {
                    // 请求失败执行代码

                });
            }
            //操作列事件
            $scope.operate = function () {

                //编辑
                $("[title='编辑']").on("click", function () {
                    var id = $(this).attr('id');
                    $http({
                        method: 'POST',
                        url: '/Security/Menu/GetMenuFunctionById',
                        data: JSON.stringify({ Id: id, menuId: menuId })
                    }).then(function successCallback(response) {
                        // 请求成功执行代码
                        $("#myModalLabel").text("编辑菜单权限");
                        $('#myModal').modal();

                        $scope.menuFcunId = response.data.Id;
                        $scope.functionName = response.data.Name;
                        $scope.functionCode = response.data.Code;
                        if (response.data.IsEnable == true) {
                            $("#isenable").attr('checked', 'checked');
                        }
                        $scope.createdTime = response.data.CreatedTime;
                        $scope.saveMenuFunction();

                    }, function errorCallback(response) {
                        // 请求失败执行代码

                    });
                });
                //删除
                $("[title='删除']").on("click", function () {
                    var id = $(this).attr('id');
                    swal({
                        title: "操作提示",
                        text: "确认删除吗?",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        cancelButtonText: "取消",
                        confirmButtonText: "确定",
                        closeOnConfirm: false
                    },
                     function () {

                         $http({
                             method: 'POST',
                             url: '/Security/Menu/DeleteMenuFunction',
                             data: JSON.stringify({ Id: id, menuId: menuId })
                         }).then(function successCallback(response) {
                             // 请求成功执行代码
                             swal("删除成功", "", "success");
                             $scope.bindMenuFunction();
                         }, function errorCallback(response) {
                             // 请求失败执行代码

                         });

                     });
                });

            }
        });

        function CreateTable(data) {
            $("tr[name='DataTr']").remove();
            $.each(data, function (index, v) {
                $("[type='checkbox']").attr('checked', 'checked');
                var $tr = $("<tr name='DataTr'></tr>");
                var $td1 = $("<td></td>").text(v.Name);
                var $td2 = $("<td></td>").text(v.Code);
                var $td3 = $("<td></td>").html("<input type='checkbox' id = 'isenable'>");
                var $td4 = $("<td></td>").html("<a title='编辑' class = 'edit' id = '" + v.Id + "'> <span class='glyphicon glyphicon-pencil aria-hidden=' true''></span></a>&nbsp&nbsp&nbsp&nbsp<a title='删除' id = '" + v.Id + "'> <span class='glyphicon glyphicon-trash aria-hidden=' true''></span></a>");
                $tr.append($td1).append($td2).append($td3).append($td4);
                $(".functionlist").append($tr);
                if (v.IsEnable == true) {
                    $("#isenable").attr('checked', 'checked');
                }
            });
        }

        function iCheck() {
            $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green',
            });
        }
        $(function () {

            $("#commentForm").validate();

            $("#enabled").attr('checked', true);
                      
            $("[title='添加菜单']").on("click", function () {
                $("#myModalLabel").text("添加菜单权限");
                $('#myModal').modal();
                $("#isEnabled").attr('checked', true);
            });
        });

    </script>



<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">新增功能菜单</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox float-e-margins">
                            <form method="get" class="form-horizontal" id="commentForm">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">功能名称</label>
                                    <div class="col-sm-7">
                                        <input type="text" name="txt_departmentname" ng-model="functionName" class="form-control" id="txt_Functionname" placeholder="功能名称">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">功能编号</label>
                                    <div class="col-sm-7">
                                        <input type="text" name="txt_departmentname" ng-model="functionCode" class="form-control" id="txt_Functioncode" placeholder="功能编号">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">
                                        是否启用
                                    </label>
                                    <div class="col-sm-7">
                                        <div class="checkbox i-checks">
                                            <label>
                                                <input type="checkbox" id="isEnabled" ng-model="isEnabled"> <i></i> 是否启用
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">创建时间</label>
                                    <div class="col-sm-7">
                                        <div class="checkbox i-checks">
                                            <label ng-model="createdtime" id="createdtime">@ViewBag.CreatedTime</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">修改时间</label>
                                    <div class="col-sm-7">
                                        <div class="checkbox i-checks">
                                            <label ng-model="updatedtime" id="updatedtime">@ViewBag.UpdatedTime</label>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" ng-click="saveMenuFunction()">保存</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>


